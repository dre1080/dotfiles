#!/bin/bash

{{ if eq .chezmoi.os "linux" }}
{{   if (.chezmoi.kernel.osrelease | lower | contains "microsoft") }}
cat << EOF | sudo tee /etc/wsl.conf >/dev/null
[boot]
systemd = true
command = mount --make-rshared /

[interop]
appendWindowsPath = false

[automount]
enabled = true
options = "metadata,umask=22,fmask=11"
EOF

WIN_HOME=$(wslpath "$(wslvar USERPROFILE)")

cat << EOF | tee $WIN_HOME/.wslconfig >/dev/null
[experimental]
autoMemoryReclaim = dropcache
sparseVhd = true

[wsl2]
guiApplications = false
EOF

echo
echo -e "\e[1;93mUpdated WSL config. Please restart WSL for changes to take effect.\e[0m"
echo
{{   end }}
{{ end }}

sudo sysctl -wq net.ipv4.ip_unprivileged_port_start=0

mkdir -p $HOME/.config/containers
cat << EOF | tee $HOME/.config/containers/registries.conf >/dev/null
unqualified-search-registries=["docker.io"]

[aliases]
"library"="docker.io/library"
EOF

ln -sf $(which podman) $HOME/.local/bin/docker

git lfs install
